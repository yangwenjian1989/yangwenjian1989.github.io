<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票空间实时表格</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        th { background-color: #f2f2f2; }
        td.hide, th.hide { display: none; }
        td.stock-name { white-space: nowrap; }
        #controls { margin-top: 10px; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h2>股票空间实时表格</h2>
    <div id="controls">
        <button onclick="startRealtime()">开始实时更新</button>
        <button onclick="stopRealtime()">停止</button>
        <button onclick="toggleCodeColumn()">显示/隐藏 股票代码</button>
        <button onclick="filterStocks()">筛选股票</button>
        <button onclick="sortByChange()">按涨跌幅排序</button>
    </div>
    <div id="result"></div>

    <script>
        let intervalId = null;
        let showCode = false;
        let isFiltered = false;
        let sortByChangePercent = false;
        let yahooCache = {}; // 存港美股数据缓存

        const stocks = [
          { code: "688361.SH", name: "中科飞测", lowLimit: 262.5, upLimit: 420 },
          { code: "002594.SZ", name: "比亚迪", lowLimit: 9800, upLimit: 14700 },
          { code: "1810.HK", name: "小米集团-W", lowLimit: 13800, upLimit: 20700 },
          { code: "600438.SH", name: "通威股份", lowLimit: 850, upLimit: 1400 },
          { code: "603596.SH", name: "伯特利", lowLimit: 300, upLimit: 450 },
          { code: "603766.SH", name: "隆鑫通用", lowLimit: 259, upLimit: 407 },
          { code: "601799.SH", name: "星宇股份", lowLimit: 320, upLimit: 512 },
          { code: "688052.SH", name: "纳芯微", lowLimit: 240.00, upLimit: 360.00 },
          { code: "300783.SZ", name: "三只松鼠", lowLimit: 94.5, upLimit: 148.5 },
          { code: "002920.SZ", name: "德赛西威", lowLimit: 544, upLimit: 816 },
          { code: "MPWR.O", name: "MPWR", lowLimit: 270, upLimit: 540 },
          { code: "300502.SZ", name: "新易盛", lowLimit: 1700, upLimit: 2550 },
          { code: "9896.HK", name: "名创优品", lowLimit: 460, upLimit: 690 },
          { code: "0388.HK", name: "香港交易所", lowLimit: 4480, upLimit: 7520 },
          { code: "603501.SH", name: "豪威集团", lowLimit: 1372.5, upLimit: 1982.5 },
          { code: "688981.SH", name: "中芯国际", lowLimit: 6800, upLimit: 9520 },
          { code: "603986.SH", name: "兆易创新", lowLimit: 768, upLimit: 1056 },
          { code: "002384.SZ", name: "东山精密", lowLimit: 850, upLimit: 1300 },
          { code: "601689.SH", name: "拓普集团", lowLimit: 700, upLimit: 1100 },
          { code: "300433.SZ", name: "蓝思科技", lowLimit: 1001, upLimit: 1638 },
          { code: "002475.SZ", name: "立讯精密", lowLimit: 2275, upLimit: 3575 },
          { code: "301029.SZ", name: "怡合达", lowLimit: 135, upLimit: 210 },
          { code: "000400.SZ", name: "许继电气", lowLimit: 200.2, upLimit: 318.5 },
          { code: "688111.SH", name: "金山办公", lowLimit: 1200, upLimit: 1800 },
          { code: "688072.SH", name: "拓荆科技", lowLimit: 380, upLimit: 617.5 },
          { code: "9985.HK", name: "卫龙美味", lowLimit: 270, upLimit: 405 },
          { code: "603179.SH", name: "新泉股份", lowLimit: 211.2, upLimit: 290.4 },
          { code: "000858.SZ", name: "五粮液", lowLimit: 4700, upLimit: 6110 },
          { code: "002518.SZ", name: "科士达", lowLimit: 110, upLimit: 180 },
          { code: "600276.SH", name: "恒瑞医药", lowLimit: 3650, upLimit: 5110 },
          { code: "688518.SH", name: "联赢激光", lowLimit: 46.8, upLimit: 93.6 },
          { code: "002050.SZ", name: "三花智控", lowLimit: 999, upLimit: 1399 },
          { code: "605117.SH", name: "德业股份", lowLimit: 414.00, upLimit: 586.5 },
          { code: "002371.SZ", name: "北方华创", lowLimit: 2145, upLimit: 2925 },
          { code: "002138.SZ", name: "顺络电子", lowLimit: 213, upLimit: 284 },
          { code: "688208.SH", name: "道通科技", lowLimit: 196, upLimit: 294 },
          { code: "601127.SH", name: "赛力斯", lowLimit: 1800, upLimit: 2520 },
          { code: "300124.SZ", name: "汇川技术", lowLimit: 1600, upLimit: 2100 },
          { code: "300442.SZ", name: "润泽科技", lowLimit: 650, upLimit: 950 },
          { code: "002847.SZ", name: "盐津铺子", lowLimit: 132, upLimit: 231 },
          { code: "002600.SZ", name: "领益智造", lowLimit: 600, upLimit: 792 },
          { code: "000333.SZ", name: "美的集团", lowLimit: 5500, upLimit: 6525 },
          { code: "300777.SZ", name: "中简科技", lowLimit: 132, upLimit: 198 },
          { code: "688305.SH", name: "科德数控", lowLimit: 62.28, upLimit: 95.15 },
          { code: "603997.SH", name: "继峰股份", lowLimit: 135, upLimit: 176 },
          { code: "689009.SH", name: "九号公司-WD", lowLimit: 404, upLimit: 525.2 },
          { code: "600519.SH", name: "贵州茅台", lowLimit: 17217.9, upLimit: 20790 },
          { code: "688019.SH", name: "安集科技", lowLimit: 190.4, upLimit: 285.6 },
          { code: "600584.SH", name: "长电科技", lowLimit: 512.5, upLimit: 717.5 },
          { code: "301345.SZ", name: "涛涛车业", lowLimit: 126, upLimit: 210 },
          { code: "000651.SZ", name: "格力电器", lowLimit: 2592, upLimit: 3060 },
          { code: "300308.SZ", name: "中际旭创", lowLimit: 1760, upLimit: 2640 },
          { code: "300693.SZ", name: "盛弘股份", lowLimit: 80, upLimit: 120 },
          { code: "002595.SZ", name: "豪迈科技", lowLimit: 412, upLimit: 515 },
          { code: "002028.SZ", name: "思源电气", lowLimit: 530.75, upLimit: 704.45 },
          { code: "605499.SH", name: "东鹏饮料", lowLimit: 1485, upLimit: 1755 },
          { code: "603129.SH", name: "春风动力", lowLimit: 287, upLimit: 436.65 },
          { code: "002444.SZ", name: "巨星科技", lowLimit: 270, upLimit: 432 },
          { code: "002126.SZ", name: "银轮股份", lowLimit: 198, upLimit: 275 },
          { code: "300627.SZ", name: "华测导航", lowLimit: 228, upLimit: 319.2 },
          { code: "0700.HK", name: "腾讯控股", lowLimit: 44000, upLimit: 56000 },
          { code: "603486.SH", name: "科沃斯", lowLimit: 320, upLimit: 540 },
          { code: "301061.SZ", name: "匠心家居", lowLimit: 146, upLimit: 227.5 },
          { code: "688698.SH", name: "伟创电气", lowLimit: 82, upLimit: 123 },
          { code: "688169.SH", name: "石头科技", lowLimit: 370, upLimit: 460 },
          { code: "688037.SH", name: "芯源微", lowLimit: 132, upLimit: 220 },
          { code: "002837.SZ", name: "英维克", lowLimit: 246, upLimit: 431 },
          { code: "300866.SZ", name: "安克创新", lowLimit: 504, upLimit: 693 },
          { code: "600114.SH", name: "东睦股份", lowLimit: 110, upLimit: 155 },
          { code: "601138.SH", name: "工业富联", lowLimit: 3965, upLimit: 6710 },
        ];

        // 批量获取港美股数据
        async function fetchYahooFinanceData(symbols) {
            const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(",")}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Yahoo Finance 请求失败");
                const data = await res.json();
                data.quoteResponse.result.forEach(item => {
                    yahooCache[item.symbol] = {
                        currentMarketCap: item.marketCap ? item.marketCap / 1e8 : null, // 亿
                        changePercent: item.regularMarketChangePercent ?? null
                    };
                });
            } catch (err) {
                console.error("Yahoo Finance 请求错误:", err);
            }
        }

        // 获取单只股票数据
        async function fetchStockData(stockCode) {
            if (stockCode.includes(".SH") || stockCode.includes(".SZ")) {
                // A股走东方财富
                const marketPrefix = stockCode.startsWith("6") ? "1" : "0";
                const code = stockCode.replace(".SH", "").replace(".SZ", "");
                const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${marketPrefix}.${code}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!data || !data.data || typeof data.data.f116 === "undefined") return null;
                    const currentMarketCap = parseFloat(data.data.f116) / 1e8;
                    let changePercent = null;
                    if (data.data.f43 && data.data.f60) {
                        const currentPrice = parseFloat(data.data.f43) / 100;
                        const yesterdayClose = parseFloat(data.data.f60) / 100;
                        changePercent = ((currentPrice - yesterdayClose) / yesterdayClose * 100).toFixed(2);
                    }
                    return { currentMarketCap, changePercent };
                } catch {
                    return null;
                }
            } else if (stockCode.includes(".HK") || stockCode.includes(".O")) {
                // 港美股走 Yahoo Finance 缓存
                const data = yahooCache[stockCode];
                if (!data || data.currentMarketCap === null) return null;
                return {
                    currentMarketCap: data.currentMarketCap,
                    changePercent: data.changePercent !== null ? data.changePercent.toFixed(2) : null
                };
            }
            return null;
        }

        // 更新表格
        async function updateTable() {
            // 先批量更新港美股数据
            const hkUsSymbols = stocks
                .map(s => s.code)
                .filter(c => c.includes(".HK") || c.includes(".O"));
            if (hkUsSymbols.length > 0) {
                await fetchYahooFinanceData(hkUsSymbols);
            }

            const resultDiv = document.getElementById('result');
            const stockData = await Promise.all(stocks.map(async stock => {
                const marketData = await fetchStockData(stock.code);
                if (!marketData) return null;
                const { currentMarketCap, changePercent } = marketData;
                const upSpace = ((stock.upLimit - currentMarketCap) / currentMarketCap * 100).toFixed(2);
                const downSpace = ((stock.lowLimit / currentMarketCap - 1) * 100).toFixed(2);
                return { ...stock, currentMarketCap, upSpace, downSpace, changePercent };
            }));

            let validData = stockData.filter(item => item !== null);

            if (isFiltered) {
                validData = validData.filter(stock => {
                    const downSpaceValue = parseFloat(stock.downSpace);
                    const upSpaceValue = parseFloat(stock.upSpace);
                    const ratio = Math.abs(upSpaceValue / downSpaceValue);
                    return downSpaceValue > -20 && ratio > 2;
                });
            }

            if (sortByChangePercent) {
                validData.sort((a, b) => {
                    const aChange = a.changePercent === null ? -Infinity : parseFloat(a.changePercent);
                    const bChange = b.changePercent === null ? -Infinity : parseFloat(b.changePercent);
                    return bChange - aChange;
                });
            } else {
                validData.sort((a, b) => parseFloat(b.upSpace) - parseFloat(a.upSpace));
            }

            let tableHTML = `
                <table>
                    <tr>
                        <th class="${showCode ? '' : 'hide'}">股票代码</th>
                        <th>股票名称</th>
                        <th>涨跌幅 (%)</th>
                        <th>当前市值 (亿元)</th>
                        <th>向上空间 (%)</th>
                        <th>向下空间 (%)</th>
                    </tr>`;

            if (validData.length === 0) {
                tableHTML += '<tr><td colspan="6">没有符合条件的股票</td></tr>';
            } else {
                validData.forEach(stock => {
                    let color = 'black';
                    let fontWeight = 'normal';
                    let changeDisplay = '-';
                    if (stock.changePercent !== null) {
                        color = stock.changePercent >= 0 ? 'red' : 'green';
                        if (Math.abs(stock.changePercent) >= 5) fontWeight = 'bold';
                        changeDisplay = stock.changePercent;
                    }
                    tableHTML += `
                        <tr>
                            <td class="${showCode ? '' : 'hide'}">${stock.code}</td>
                            <td class="stock-name">${stock.name}</td>
                            <td style="color:${color}; font-weight:${fontWeight};">${changeDisplay}</td>
                            <td>${stock.currentMarketCap.toFixed(2)}</td>
                            <td>${stock.upSpace}</td>
                            <td>${stock.downSpace}</td>
                        </tr>`;
                });
            }

            tableHTML += '</table>';
            resultDiv.innerHTML = tableHTML;
        }

        function toggleCodeColumn() {
            showCode = !showCode;
            updateTable();
        }

        function filterStocks() {
            isFiltered = !isFiltered;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${isFiltered ? '已应用筛选条件' : '已取消筛选'}</strong>`;
        }

        function sortByChange() {
            sortByChangePercent = !sortByChangePercent;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${sortByChangePercent ? '已按涨跌幅排序' : '已恢复默认排序'}</strong>`;
        }

        function startRealtime() {
            if (intervalId) return;
            updateTable();
            intervalId = setInterval(updateTable, 2000);
        }

        function stopRealtime() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                document.getElementById('result').innerHTML += '<br><strong>已停止实时更新</strong>';
            }
        }
    </script>
</body>
</html>
