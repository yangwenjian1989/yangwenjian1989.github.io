<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票空间实时表格</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        th { background-color: #f2f2f2; }
        td.hide, th.hide { display: none; }
        td.stock-name { white-space: nowrap; }
        #controls { margin-top: 10px; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h2>股票空间实时表格</h2>
    <div id="controls">
        <button onclick="startRealtime()">开始实时更新</button>
        <button onclick="stopRealtime()">停止</button>
        <button onclick="toggleCodeColumn()">显示/隐藏 股票代码</button>
        <button onclick="filterStocks()">筛选股票</button>
        <button onclick="sortByChange()">按涨跌幅排序</button>
    </div>
    <div id="result"></div>

    <script>
        let intervalId = null;
        let showCode = false;
        let isFiltered = false;
        let sortByChangePercent = false;
        let yahooCache = {}; // 存港美股数据缓存

        const stocks = [
            { code: "688361.SH", name: "中科飞测", lowLimit: 262.5, upLimit: 420 },
            { code: "002594.SZ", name: "比亚迪", lowLimit: 9800, upLimit: 14700 },
            { code: "1810.HK", name: "小米集团-W", lowLimit: 13800, upLimit: 20700 },
            { code: "600438.SH", name: "通威股份", lowLimit: 850, upLimit: 1400 },
            { code: "603596.SH", name: "伯特利", lowLimit: 300, upLimit: 450 },
            { code: "MPWR.O", name: "MPWR", lowLimit: 270, upLimit: 540 },
            { code: "0700.HK", name: "腾讯控股", lowLimit: 44000, upLimit: 56000 },
            { code: "AAPL.O", name: "苹果公司", lowLimit: 250, upLimit: 400 }
        ];

        // 批量获取港美股数据
        async function fetchYahooFinanceData(symbols) {
            const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(",")}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Yahoo Finance 请求失败");
                const data = await res.json();
                data.quoteResponse.result.forEach(item => {
                    yahooCache[item.symbol] = {
                        currentMarketCap: item.marketCap ? item.marketCap / 1e8 : null, // 亿
                        changePercent: item.regularMarketChangePercent ?? null
                    };
                });
            } catch (err) {
                console.error("Yahoo Finance 请求错误:", err);
            }
        }

        // 获取单只股票数据
        async function fetchStockData(stockCode) {
            if (stockCode.includes(".SH") || stockCode.includes(".SZ")) {
                // A股走东方财富
                const marketPrefix = stockCode.startsWith("6") ? "1" : "0";
                const code = stockCode.replace(".SH", "").replace(".SZ", "");
                const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${marketPrefix}.${code}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!data || !data.data || typeof data.data.f116 === "undefined") return null;
                    const currentMarketCap = parseFloat(data.data.f116) / 1e8;
                    let changePercent = null;
                    if (data.data.f43 && data.data.f60) {
                        const currentPrice = parseFloat(data.data.f43) / 100;
                        const yesterdayClose = parseFloat(data.data.f60) / 100;
                        changePercent = ((currentPrice - yesterdayClose) / yesterdayClose * 100).toFixed(2);
                    }
                    return { currentMarketCap, changePercent };
                } catch {
                    return null;
                }
            } else if (stockCode.includes(".HK") || stockCode.includes(".O")) {
                // 港美股走 Yahoo Finance 缓存
                const data = yahooCache[stockCode];
                if (!data || data.currentMarketCap === null) return null;
                return {
                    currentMarketCap: data.currentMarketCap,
                    changePercent: data.changePercent !== null ? data.changePercent.toFixed(2) : null
                };
            }
            return null;
        }

        // 更新表格
        async function updateTable() {
            // 先批量更新港美股数据
            const hkUsSymbols = stocks
                .map(s => s.code)
                .filter(c => c.includes(".HK") || c.includes(".O"));
            if (hkUsSymbols.length > 0) {
                await fetchYahooFinanceData(hkUsSymbols);
            }

            const resultDiv = document.getElementById('result');
            const stockData = await Promise.all(stocks.map(async stock => {
                const marketData = await fetchStockData(stock.code);
                if (!marketData) return null;
                const { currentMarketCap, changePercent } = marketData;
                const upSpace = ((stock.upLimit - currentMarketCap) / currentMarketCap * 100).toFixed(2);
                const downSpace = ((stock.lowLimit / currentMarketCap - 1) * 100).toFixed(2);
                return { ...stock, currentMarketCap, upSpace, downSpace, changePercent };
            }));

            let validData = stockData.filter(item => item !== null);

            if (isFiltered) {
                validData = validData.filter(stock => {
                    const downSpaceValue = parseFloat(stock.downSpace);
                    const upSpaceValue = parseFloat(stock.upSpace);
                    const ratio = Math.abs(upSpaceValue / downSpaceValue);
                    return downSpaceValue > -20 && ratio > 2;
                });
            }

            if (sortByChangePercent) {
                validData.sort((a, b) => {
                    const aChange = a.changePercent === null ? -Infinity : parseFloat(a.changePercent);
                    const bChange = b.changePercent === null ? -Infinity : parseFloat(b.changePercent);
                    return bChange - aChange;
                });
            } else {
                validData.sort((a, b) => parseFloat(b.upSpace) - parseFloat(a.upSpace));
            }

            let tableHTML = `
                <table>
                    <tr>
                        <th class="${showCode ? '' : 'hide'}">股票代码</th>
                        <th>股票名称</th>
                        <th>涨跌幅 (%)</th>
                        <th>当前市值 (亿元)</th>
                        <th>向上空间 (%)</th>
                        <th>向下空间 (%)</th>
                    </tr>`;

            if (validData.length === 0) {
                tableHTML += '<tr><td colspan="6">没有符合条件的股票</td></tr>';
            } else {
                validData.forEach(stock => {
                    let color = 'black';
                    let fontWeight = 'normal';
                    let changeDisplay = '-';
                    if (stock.changePercent !== null) {
                        color = stock.changePercent >= 0 ? 'red' : 'green';
                        if (Math.abs(stock.changePercent) >= 5) fontWeight = 'bold';
                        changeDisplay = stock.changePercent;
                    }
                    tableHTML += `
                        <tr>
                            <td class="${showCode ? '' : 'hide'}">${stock.code}</td>
                            <td class="stock-name">${stock.name}</td>
                            <td style="color:${color}; font-weight:${fontWeight};">${changeDisplay}</td>
                            <td>${stock.currentMarketCap.toFixed(2)}</td>
                            <td>${stock.upSpace}</td>
                            <td>${stock.downSpace}</td>
                        </tr>`;
                });
            }

            tableHTML += '</table>';
            resultDiv.innerHTML = tableHTML;
        }

        function toggleCodeColumn() {
            showCode = !showCode;
            updateTable();
        }

        function filterStocks() {
            isFiltered = !isFiltered;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${isFiltered ? '已应用筛选条件' : '已取消筛选'}</strong>`;
        }

        function sortByChange() {
            sortByChangePercent = !sortByChangePercent;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${sortByChangePercent ? '已按涨跌幅排序' : '已恢复默认排序'}</strong>`;
        }

        function startRealtime() {
            if (intervalId) return;
            updateTable();
            intervalId = setInterval(updateTable, 2000);
        }

        function stopRealtime() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                document.getElementById('result').innerHTML += '<br><strong>已停止实时更新</strong>';
            }
        }
    </script>
</body>
</html>
