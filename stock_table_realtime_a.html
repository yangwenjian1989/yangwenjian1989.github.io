<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票空间实时表格</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        td.hide, th.hide { display: none; }
        #controls { margin-top: 10px; }
        #result { margin-top: 20px; }
        #debug { margin-top: 20px; font-size: 12px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <h2>股票空间实时表格</h2>
    <div id="controls">
        <button onclick="startRealtime()">开始实时更新</button>
        <button onclick="stopRealtime()">停止</button>
        <button onclick="toggleCodeColumn()">显示/隐藏 股票代码</button>
    </div>
    <div id="result"></div>
    <div id="debug"></div>

    <script>
        let intervalId = null;
        let showCode = false;

        const stocks = [
            { code: "300433.SZ", name: "蓝思科技", lowLimit: 800, upLimit: 1760 },
            { code: "600438.SH", name: "通威股份", lowLimit: 850, upLimit: 1400 },
            { code: "002475.SZ", name: "立讯精密", lowLimit: 2100, upLimit: 3531 },
        ];

        async function fetchStockData(stockCode) {
            const marketPrefix = stockCode.includes('.SH') || stockCode.includes('.SZ') ?
                (stockCode.startsWith('6') ? '1' : '0') : '';
            const code = stockCode.replace('.SH', '').replace('.SZ', '').replace('.HK', '');
            const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${marketPrefix}.${code}`;
            const debugDiv = document.getElementById('debug');

            debugDiv.innerHTML += `<p>尝试请求 ${stockCode}: ${url}</p>`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP 错误: ${response.status}`);
                }
                const data = await response.json();

                debugDiv.innerHTML += 
                    `<p>股票 ${stockCode} 返回数据: <pre>${JSON.stringify(data, null, 2)}</pre></p>`;

                if (!data || !data.data || typeof data.data.f116 === 'undefined') {
                    throw new Error(`无法获取 ${stockCode} 的市值数据`);
                }

                const currentMarketCap = parseFloat(data.data.f116) / 1e8;
                let changePercent = null;

                // 优先检查 f170（涨跌额）和 f46（昨收价）计算涨跌幅
                if (data.data.f170 !== undefined && data.data.f46 !== undefined && 
                    !isNaN(parseFloat(data.data.f170)) && !isNaN(parseFloat(data.data.f46))) {
                    const changeAmount = parseFloat(data.data.f170);
                    const yesterdayClose = parseFloat(data.data.f46);
                    changePercent = (changeAmount / yesterdayClose * 100).toFixed(2);
                    debugDiv.innerHTML += `<p>股票 ${stockCode} 使用 f170 计算涨跌幅: ${changePercent}%</p>`;
                }
                // 如果没有 f170，则用 f43（最新价）和 f46（昨收价）计算
                else if (data.data.f43 !== undefined && data.data.f46 !== undefined && 
                    !isNaN(parseFloat(data.data.f43)) && !isNaN(parseFloat(data.data.f46))) {
                    const currentPrice = parseFloat(data.data.f43);
                    const yesterdayClose = parseFloat(data.data.f46);
                    changePercent = ((currentPrice - yesterdayClose) / yesterdayClose * 100).toFixed(2);
                    debugDiv.innerHTML += `<p>股票 ${stockCode} 使用 f43 和 f46 计算涨跌幅: ${changePercent}%</p>`;
                } else {
                    debugDiv.innerHTML += 
                        `<p style="color: orange;">警告: 股票 ${stockCode} 无可用涨跌幅字段</p>`;
                }

                return { currentMarketCap, changePercent };
            } catch (error) {
                debugDiv.innerHTML += 
                    `<p style="color: red;">错误 - ${stockCode}: ${error.message}</p>`;
                return null;
            }
        }

        async function updateTable() {
            const resultDiv = document.getElementById('result');
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML = '<h3>调试信息</h3>';

            const stockData = await Promise.all(stocks.map(async stock => {
                const marketData = await fetchStockData(stock.code);
                if (marketData === null) return null;

                const { currentMarketCap, changePercent } = marketData;
                const upSpace = ((stock.upLimit - currentMarketCap) / currentMarketCap * 100).toFixed(2);
                const downSpace = ((stock.lowLimit / currentMarketCap - 1) * 100).toFixed(2);

                return { ...stock, currentMarketCap, upSpace, downSpace, changePercent };
            }));

            const validData = stockData.filter(item => item !== null);
            validData.sort((a, b) => parseFloat(b.upSpace) - parseFloat(a.upSpace));

            let tableHTML = `
                <table>
                    <tr>
                        <th class="${showCode ? '' : 'hide'}">股票代码</th>
                        <th>股票名称</th>
                        <th>涨跌幅 (%)</th>
                        <th>当前市值 (亿元)</th>
                        <th>向上空间 (%)</th>
                        <th>向下空间 (%)</th>
                    </tr>`;

            validData.forEach(stock => {
                let color = 'black';
                let fontWeight = 'normal';
                let changeDisplay = '-';

                if (stock.changePercent !== null) {
                    color = stock.changePercent >= 0 ? 'red' : 'green';
                    if (Math.abs(stock.changePercent) >= 5) fontWeight = 'bold';
                    changeDisplay = stock.changePercent;
                }

                tableHTML += `
                    <tr>
                        <td class="${showCode ? '' : 'hide'}">${stock.code}</td>
                        <td>${stock.name}</td>
                        <td style="color:${color}; font-weight:${fontWeight};">${changeDisplay}</td>
                        <td>${stock.currentMarketCap.toFixed(2)}</td>
                        <td>${stock.upSpace}</td>
                        <td>${stock.downSpace}</td>
                    </tr>`;
            });

            tableHTML += '</table>';
            resultDiv.innerHTML = tableHTML;
        }

        function toggleCodeColumn() {
            showCode = !showCode;
            updateTable();
        }

        function startRealtime() {
            if (intervalId) return;
            updateTable();
            intervalId = setInterval(updateTable, 2000);
        }

        function stopRealtime() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                document.getElementById('result').innerHTML += '<br><strong>已停止实时更新</strong>';
            }
        }
    </script>
</body>
</html>
