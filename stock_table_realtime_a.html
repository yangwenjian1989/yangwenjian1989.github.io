<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时表格</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        th { background-color: #f2f2f2; }
        td.hide, th.hide { display: none; }
        td.stock-name { white-space: nowrap; }
        #controls { margin-top: 10px; }
        #result { margin-top: 20px; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h2>实时表格:20250914</h2>
    <div id="controls">
        <button onclick="startRealtime()">开始实时更新</button>
        <button onclick="stopRealtime()">停止</button>
        <button onclick="toggleCodeColumn()">显示/隐藏 股票代码</button>
        <button onclick="filterStocks()">筛选股票</button>
        <button onclick="sortByChange()">按涨跌幅排序</button>
    </div>
    <div id="result"></div>

    <script>
        let intervalId = null;
        let showCode = false;
        let isFiltered = false;
        let sortByChangePercent = false;

        const stocks = [
          { code: "603005.SH", name: "晶方科技", lowLimit: 182, upLimit: 330 },
          { code: "002602.SZ", name: "st华通", lowLimit: 1100, upLimit: 2200 },
          { code: "688208.SH", name: "道通科技", lowLimit: 200, upLimit: 400 },
          { code: "9896.HK", name: "名创优品", lowLimit: 460, upLimit: 920 },
          { code: "688169.SH", name: "石头科技", lowLimit: 520, upLimit: 780 },
          { code: "688362.SH", name: "甬矽电子", lowLimit: 113, upLimit: 203 },
          { code: "601933.SH", name: "永辉超市", lowLimit: 350, upLimit: 700 },
          { code: "688361.SH", name: "中科飞测", lowLimit: 262.5, upLimit: 420 },
          { code: "1810.HK", name: "小米集团-W", lowLimit: 13800, upLimit: 20700 },
          { code: "2020.HK", name: "安踏体育", lowLimit: 2794, upLimit: 3775 },
          { code: "688052.SH", name: "纳芯微", lowLimit: 244, upLimit: 366 },
          { code: "689009.SH", name: "九号公司-WD", lowLimit: 500, upLimit: 700 },
          { code: "002594.SZ", name: "比亚迪", lowLimit: 9200, upLimit: 13800 },
          { code: "688072.SH", name: "拓荆科技", lowLimit: 430, upLimit: 700 },
          { code: "600438.SH", name: "通威股份", lowLimit: 850, upLimit: 1400 },
          { code: "301061.SZ", name: "匠心家居", lowLimit: 190, upLimit: 285 },
          { code: "603766.SH", name: "隆鑫通用", lowLimit: 246.05, upLimit: 333 },
          { code: "MPWR", name: "MPWR", lowLimit: 270, upLimit: 540 },
          { code: "603596.SH", name: "伯特利", lowLimit: 269.8, upLimit: 383.4 },
          { code: "600563.SH", name: "法拉电子", lowLimit: 232, upLimit: 348 },
          { code: "688111.SH", name: "金山办公", lowLimit: 1200, upLimit: 1800 },
          { code: "002920.SZ", name: "德赛西威", lowLimit: 560, upLimit: 840 },
          { code: "0388.HK", name: "香港交易所", lowLimit: 4900, upLimit: 7000 },
          { code: "000333.SZ", name: "美的集团", lowLimit: 5500, upLimit: 7350 },
          { code: "601799.SH", name: "星宇股份", lowLimit: 320, upLimit: 432 },
          { code: "000400.SZ", name: "许继电气", lowLimit: 187, upLimit: 297.5 },
          { code: "603501.SH", name: "豪威集团", lowLimit: 1448.75, upLimit: 1982.5 },
          { code: "002648.SZ", name: "卫星化学", lowLimit: 410, upLimit: 819 },
          { code: "001309.SZ", name: "德明利", lowLimit: 216, upLimit: 272 },
          { code: "9985.HK", name: "卫龙美味", lowLimit: 263.5, upLimit: 387.5 },
          { code: "000858.SZ", name: "五粮液", lowLimit: 4550, upLimit: 5915 },
          { code: "601233.SH", name: "桐昆股份", lowLimit: 126, upLimit: 420 },
          { code: "301029.SZ", name: "怡合达", lowLimit: 156.8, upLimit: 224 },
          { code: "603997.SH", name: "继峰股份", lowLimit: 135, upLimit: 176 },
          { code: "002847.SZ", name: "盐津铺子", lowLimit: 127, upLimit: 222.25 },
          { code: "300866.SZ", name: "安克创新", lowLimit: 630, upLimit: 850.5 },
          { code: "688981.SH", name: "中芯国际", lowLimit: 6800, upLimit: 10200 },
          { code: "300433.SZ", name: "蓝思科技", lowLimit: 1104, upLimit: 1840 },
          { code: "300502.SZ", name: "新易盛", lowLimit: 3132, upLimit: 4350 },
          { code: "605499.SH", name: "东鹏饮料", lowLimit: 1518, upLimit: 1794 },
          { code: "300124.SZ", name: "汇川技术", lowLimit: 1600, upLimit: 2500 },
          { code: "300777.SZ", name: "中简科技", lowLimit: 120, upLimit: 180 },
          { code: "300750.SZ", name: "宁德时代", lowLimit: 12060, upLimit: 16750 },
          { code: "300783.SZ", name: "三只松鼠", lowLimit: 84, upLimit: 120 },
          { code: "002558.SZ", name: "巨人网络", lowLimit: 480, upLimit: 960 },
          { code: "688037.SH", name: "芯源微", lowLimit: 160, upLimit: 280 },
          { code: "002444.SZ", name: "巨星科技", lowLimit: 324, upLimit: 432 },
          { code: "000651.SZ", name: "格力电器", lowLimit: 2000, upLimit: 2600 },
          { code: "603129.SH", name: "春风动力", lowLimit: 353.4, upLimit: 465 },
          { code: "300274.SZ", name: "阳光电源", lowLimit: 1885, upLimit: 3190 },
          { code: "601127.SH", name: "赛力斯", lowLimit: 1700, upLimit: 2550 },
          { code: "300627.SZ", name: "华测导航", lowLimit: 228, upLimit: 319.2 },
          { code: "002126.SZ", name: "银轮股份", lowLimit: 231, upLimit: 346.5 },
          { code: "002595.SZ", name: "豪迈科技", lowLimit: 440, upLimit: 550 },
          { code: "300442.SZ", name: "润泽科技", lowLimit: 650, upLimit: 950 },
          { code: "600519.SH", name: "贵州茅台", lowLimit: 17860, upLimit: 20680 },
          { code: "002028.SZ", name: "思源电气", lowLimit: 604.5, upLimit: 780 },
          { code: "002371.SZ", name: "北方华创", lowLimit: 2145, upLimit: 2925 },
          { code: "300308.SZ", name: "中际旭创", lowLimit: 3150, upLimit: 5250 },
          { code: "600584.SH", name: "长电科技", lowLimit: 504, upLimit: 720 },
          { code: "002138.SZ", name: "顺络电子", lowLimit: 255.5, upLimit: 310.25 },
          { code: "600276.SH", name: "恒瑞医药", lowLimit: 3400, upLimit: 4760 },
          { code: "603486.SH", name: "科沃斯", lowLimit: 360, upLimit: 607.5 },
          { code: "002475.SZ", name: "立讯精密", lowLimit: 2930.4, upLimit: 4162.5 },
          { code: "002384.SZ", name: "东山精密", lowLimit: 1050, upLimit: 1500 },
          { code: "301345.SZ", name: "涛涛车业", lowLimit: 135, upLimit: 225 },
          { code: "002938.SZ", name: "鹏鼎控股", lowLimit: 660, upLimit: 1320 },
          { code: "600114.SH", name: "东睦股份", lowLimit: 122, upLimit: 186 },
          { code: "688019.SH", name: "安集科技", lowLimit: 200, upLimit: 300 },
          { code: "0700.HK", name: "腾讯控股", lowLimit: 45100, upLimit: 57400 },
          { code: "600426.SH", name: "华鲁恒升", lowLimit: 342, upLimit: 540 },
          { code: "688518.SH", name: "联赢激光", lowLimit: 44.2, upLimit: 88.4 },
          { code: "601689.SH", name: "拓普集团", lowLimit: 700, upLimit: 1100 },
          { code: "688305.SH", name: "科德数控", lowLimit: 50.4, upLimit: 77 },
          { code: "002050.SZ", name: "三花智控", lowLimit: 960, upLimit: 1344 },
          { code: "605117.SH", name: "德业股份", lowLimit: 442, upLimit: 612 },
          { code: "002600.SZ", name: "领益智造", lowLimit: 625, upLimit: 925 },
          { code: "300693.SZ", name: "盛弘股份", lowLimit: 74, upLimit: 111 },
          { code: "603986.SH", name: "兆易创新", lowLimit: 760, upLimit: 1045 },
          { code: "688698.SH", name: "伟创电气", lowLimit: 80, upLimit: 120 },
          { code: "603179.SH", name: "新泉股份", lowLimit: 211.2, upLimit: 290.4 },
          { code: "002518.SZ", name: "科士达", lowLimit: 110, upLimit: 180 },
          { code: "601336.SH", name: "新华保险", lowLimit: 1100, upLimit: 1500 },
          { code: "601138.SH", name: "工业富联", lowLimit: 5025, upLimit: 8375 },
          { code: "002837.SZ", name: "英维克", lowLimit: 260, upLimit: 455 }
        ];

        // 获取 secid
        function getSecid(stockCode) {
            let prefix, scode;
            if (stockCode.endsWith('.SH')) {
                prefix = '1';
                scode = stockCode.replace('.SH', '');
            } else if (stockCode.endsWith('.SZ')) {
                prefix = '0';
                scode = stockCode.replace('.SZ', '');
            } else if (stockCode.endsWith('.HK')) {
                prefix = '116';
                scode = stockCode.replace('.HK', '').padStart(5, '0');
            } else {
                // 假设美股 NASDAQ
                prefix = '105';
                scode = stockCode;
            }
            return `${prefix}.${scode}`;
        }

        // 获取单只股票数据（统一使用东方财富 API）
        async function fetchStockData(stockCode) {
            const secid = getSecid(stockCode);
            if (!secid) return null;
            const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${secid}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data || !data.data || typeof data.data.f116 === "undefined") return null;
                const currentMarketCap = parseFloat(data.data.f116) / 1e8; // 亿元（保持原单位）
                let changePercent = null;
                if (data.data.f43 && data.data.f60) {
                    const currentPrice = parseFloat(data.data.f43) / 100;
                    const yesterdayClose = parseFloat(data.data.f60) / 100;
                    changePercent = ((currentPrice - yesterdayClose) / yesterdayClose * 100).toFixed(2);
                }
                return { currentMarketCap, changePercent };
            } catch (err) {
                console.error(`东方财富请求错误 (${stockCode}):`, err);
                return null;
            }
        }

        // 更新表格
        async function updateTable() {
            const resultDiv = document.getElementById('result');
            const stockData = await Promise.all(stocks.map(async stock => {
                const marketData = await fetchStockData(stock.code);
                if (!marketData) return null;
                const { currentMarketCap, changePercent } = marketData;
                const upSpace = ((stock.upLimit - currentMarketCap) / currentMarketCap * 100).toFixed(2);
                const downSpace = ((stock.lowLimit / currentMarketCap - 1) * 100).toFixed(2);
                return { ...stock, currentMarketCap, upSpace, downSpace, changePercent };
            }));

            let validData = stockData.filter(item => item !== null);

            if (isFiltered) {
                validData = validData.filter(stock => {
                    const downSpaceValue = parseFloat(stock.downSpace);
                    const upSpaceValue = parseFloat(stock.upSpace);
                    const ratio = Math.abs(upSpaceValue / downSpaceValue);
                    return downSpaceValue > -20 && ratio > 2;
                });
            }

            if (sortByChangePercent) {
                validData.sort((a, b) => {
                    const aChange = a.changePercent === null ? -Infinity : parseFloat(a.changePercent);
                    const bChange = b.changePercent === null ? -Infinity : parseFloat(b.changePercent);
                    return bChange - aChange;
                });
            } else {
                validData.sort((a, b) => parseFloat(b.upSpace) - parseFloat(a.upSpace));
            }

            let tableHTML = `
                <table>
                    <tr>
                        <th class="${showCode ? '' : 'hide'}">股票代码</th>
                        <th>股票名称</th>
                        <th>涨跌幅 (%)</th>
                        <th>当前市值 (亿元)</th>
                        <th>向上空间 (%)</th>
                        <th>向下空间 (%)</th>
                    </tr>`;

            if (validData.length === 0) {
                tableHTML += '<tr><td colspan="6">没有符合条件的股票</td></tr>';
            } else {
                validData.forEach(stock => {
                    let color = 'black';
                    let fontWeight = 'normal';
                    let changeDisplay = '-';
                    if (stock.changePercent !== null) {
                        changeDisplay = stock.changePercent;
                        color = parseFloat(stock.changePercent) >= 0 ? 'red' : 'green';
                        if (Math.abs(parseFloat(stock.changePercent)) >= 5) fontWeight = 'bold';
                    }
                    tableHTML += `
                        <tr>
                            <td class="${showCode ? '' : 'hide'}">${stock.code}</td>
                            <td class="stock-name">${stock.name}</td>
                            <td style="color:${color}; font-weight:${fontWeight};">${changeDisplay}</td>
                            <td>${stock.currentMarketCap.toFixed(2)}</td>
                            <td>${stock.upSpace}</td>
                            <td>${stock.downSpace}</td>
                        </tr>`;
                });
            }

            tableHTML += '</table>';
            resultDiv.innerHTML = tableHTML;
        }

        function toggleCodeColumn() {
            showCode = !showCode;
            updateTable();
        }

        function filterStocks() {
            isFiltered = !isFiltered;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${isFiltered ? '已应用筛选条件' : '已取消筛选'}</strong>`;
        }

        function sortByChange() {
            sortByChangePercent = !sortByChangePercent;
            updateTable();
            document.getElementById('result').innerHTML += `<br><strong>${sortByChangePercent ? '已按涨跌幅排序' : '已恢复默认排序'}</strong>`;
        }

        function startRealtime() {
            if (intervalId) return;
            updateTable();
            intervalId = setInterval(updateTable, 2000);
        }

        function stopRealtime() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                document.getElementById('result').innerHTML += '<br><strong>已停止实时更新</strong>';
            }
        }
    </script>
</body>
</html>
